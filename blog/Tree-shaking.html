<html><head><title>Fable Blog</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:title" content="Fable"/><meta name="twitter:description" content="F# to JS compiler"/><meta name="twitter:image" content="https://fable.io/img/fable_logo.png"/><meta name="twitter:card" content="summary_large_image"/><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,300,600,700|Roboto+Mono|Fira+Code|Open+Sans:400,300,600,700"/><script src="https://kit.fontawesome.com/f1c8a90b9d.js"></script><link rel="stylesheet" type="text/css" href="/css/styles.css"/><link rel="stylesheet" type="text/css" href="/css/prism.css"/><link rel="shortcut icon" href="/img/fable.ico"/></head><body><nav class="navbar"><div class="navbar-brand"><a class="navbar-item is-size-4" href="/" style="background-color:rgba(0,0,0,0.5);color:dodgerblue;font-weight:600">Fable</a><div class="navbar-burger" data-target="navMenu"><span></span><span></span><span></span></div></div><div id="navMenu" class=" navbar-menu"><div class="navbar-start"><a class=" navbar-item" href="/docs">Docs</a><a class=" navbar-item is-active" href="/blog">Blog</a><a class=" navbar-item" href="/repl">REPL</a><a class=" navbar-item" href="/community">Community</a><a class=" navbar-item" href="/fableconf">FableConf</a></div><div class="navbar-end"><div class="field is-grouped"><a class="navbar-item" href="https://gitter.im/fable-compiler/Fable" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-gitter"></i></span></a><a class="navbar-item" href="https://github.com/fable-compiler/fable" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-github"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-twitter"></i></span></a></div></div></div></nav><div class="markdown blog" style="overflow:hidden"><div class="columns fable-header" style="margin:20px 0"><div class="column is-offset-one-quarter"><figure class="image" style="max-width:500px;margin-left:auto;margin-right:auto"><img class="fable-logo" src="/img/fable_logo.png"/></figure></div><div class="column fable-header-buttons" style="display:flex;flex-direction:column;justify-content:center"><div style="width:250px;margin:0.5rem 0"><a style="margin:10px" href="/repl/" target="_black"><button class="button is-fullwidth is-outlined is-medium is-success" style="font-size:1rem">TRY ONLINE</button></a></div><div style="width:250px;margin:0.5rem 0"><a style="margin:10px" href="/docs/2-steps/setup.html"><button class="button is-fullwidth is-outlined is-medium is-info" style="font-size:1rem">GET STARTED</button></a></div><div style="width:250px;margin:0.5rem 0"><a style="margin:10px" href="/fableconf"><button class="button is-fullwidth is-outlined is-medium is-danger" style="font-size:1rem">JOIN FABLECONF!</button></a></div></div></div><div style="margin-top:1.6rem"><div class="columns"><div class="column"></div><div class="column is-two-thirds"><div class="content" style="margin:5px"><p>Hi everybody! This is my first contribution to the <a href="https://sergeytihon.wordpress.com/2016/10/23/f-advent-calendar-in-english-2016/">F# advent calendar</a> and you&#39;ll probably be very surprised to know it will be about... Fable! Yes, the lightweight F# compiler that emits JavaScript you can be proud of (or at least I&#39;ll be). This time I want to talk you about one of the exciting new features introduced in <a href="blog/Introducing-0-7.html">Fable 0.7</a>: tree shaking.</p>
<hr>
<p>From the very fist version, Fable compiles F# code to JavaScript using <a href="https://babeljs.io/docs/learn-es2015/">ES2015 features</a> like classes or iterators, and then uses <a href="https://babeljs.io/">Babel</a> (hence the name) to convert the code to something old browsers don&#39;t have that much trouble understanding. Among ES2015 features we find a new <a href="http://www.2ality.com/2014/09/es6-modules-final.html">module system</a> that it&#39;s been designed to standardize the different solutions that tried to emulate modules in JS so far, like <a href="https://nodejs.org/docs/latest/api/modules.html">commonjs</a> or <a href="http://requirejs.org/docs/whyamd.html">amd</a>. But why create a new standard instead of taking one of existing ones?</p>
<p><img src="/img/blog/standards.png" alt="How standards proliferate"></p>
<blockquote>
<p>Image courtesy of <a href="https://xkcd.com/927/">xkcd.com</a></p>
</blockquote>
<p>Because, both <code>commonjs</code> and <code>amd</code>, in the spirit of the JS language, allow for dynamic module patching so it&#39;s difficult to know what you are actually loading until runtime. ES2015 modules are designed so they can be <strong>analyzed statically</strong> (meaning <em>at compile time</em>). This has several applications but it&#39;s mostly important for bundlers. Now let&#39;s start a digression to talk about bundlers.</p>
<p><code>&lt;digression&gt;</code>The JavaScript ecosystem has grown enormously in recent years and nowadays we can find a library or component for almost anything. However, JS being an interpreted language it has no compiler to link all the source files and loading them with <code>script</code> HTML tags becomes a nightmare in a rapidly changing development environment. Luckily, tools like <a href="https://webpack.github.io/">Webpack</a> can pack all our sources into a single file for easy deployment.<code>&lt;/digression&gt;</code></p>
<p>Bundlers are nice but the obvious gotcha is we need to be careful not to convert our app in a monster of several MB that takes forever to load. Bundlers and tools like <a href="http://lisperator.net/uglifyjs/">UglifyJS</a> try to mitigate this by removing <strong>dead code</strong>, however due to the commented dynamic nature of JS, many times it&#39;s not possible to know what it&#39;s actually used or not until runtime. Because of this, JS libraries compete to be as small in size as possible by specializing and resolving very specific problems. The result: JS apps with hundreds of dependencies and an ecosystem full of tiny packages where this year a single developer <a href="http://www.theregister.co.uk/2016/03/23/npm_left_pad_chaos/">broke the internet by retiring 11 lines of code from npm</a>.</p>
<h2><a name="individual-imports-and-exports" class="anchor" href="#individual-imports-and-exports">Individual imports and exports</a></h2><p><a href="http://rollupjs.org/">Rollup</a> is a bundler that understands ES2015 modules and its author, Rich Harris, can explain much better than me <a href="https://medium.com/@Rich_Harris/small-modules-it-s-not-quite-that-simple-3ca532d65de4#.bwwly4tk3">the problems of small modules</a> and <a href="https://medium.com/@Rich_Harris/tree-shaking-versus-dead-code-elimination-d3765df85c80#.nnofvhkml">the advantages of tree shaking over dead code elimination</a>, but I&#39;ll try to summarize them:</p>
<p>The killer feature of ES2015 modules is they allow to make <strong>individual exports and imports</strong>. This means you can reference a library without importing the whole package, only the functions you need. And most importantly, library authors are encouraged to structure their code having this in mind. Then, bundlers (and browsers soon) can easily eliminate anything that&#39;s not being imported. Consider this simplistic JS project and the generated bundle.</p>
<p>maths.js</p>
<pre><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">square</span> <span class="token punctuation">(</span> <span class="token parameter">x</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cube</span> <span class="token punctuation">(</span> <span class="token parameter">x</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>main.js (entry module)</p>
<pre><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> cube <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./maths.js'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">cube</span><span class="token punctuation">(</span> <span class="token number">5</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 125</span></code></pre>
<p>bundle.js (<code>square</code> is excluded)</p>
<pre><code class="language-js"><span class="token keyword">function</span> <span class="token function">cube</span> <span class="token punctuation">(</span> <span class="token parameter">x</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">*</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">cube</span><span class="token punctuation">(</span> <span class="token number">5</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Check Rollup&#39;s website to see how this works <a href="http://rollupjs.org/">live</a>.</p>
<p>Cool, isn&#39;t it? But... wait, what am I doing? I wanted to convince you to try Fable and here I am only talking about the niceties of ES2015 modules. Obviously, it&#39;s not possible for Fable to have any advantage regarding a feature that was specifically designed for JS and its ecosystem, right? Well, let&#39;s see. Challenge accepted!</p>
<h2><a name="autocompletion" class="anchor" href="#autocompletion">Autocompletion</a></h2><p>ES2015 modules are very nice but there&#39;s one little problem: they make <strong>exploratory programming</strong> more difficult. We need to know the bits of the library we want to import in advance, which means we must check the documentation carefully to see what we actually need and we cannot use the tremendously productive autocompletion capabilities of IDEs like <a href="https://code.visualstudio.com/">Visual Studio Code</a> to explore the API as we code. <strong>Not even with TypeScript</strong>, a statically typed language, as it uses the same syntax as ES2015 for importing modules.</p>
<p>Enter Fable (finally!). Provided you have a single root module per file, Fable will automatically export your public functions with ES2015 syntax. Check the following code and the generated JS:</p>
<pre><code class="language-fsharp"><span class="token keyword">module</span> MyNamespace<span class="token punctuation">.</span>MyModule

<span class="token keyword">let</span> foo x <span class="token operator">=</span>
  x <span class="token operator">+</span> x

<span class="token keyword">let</span> bar y <span class="token operator">=</span>
  y <span class="token operator">*</span> y</code></pre>
<pre><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">+</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> y <span class="token operator">*</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Noticed that? Fable doesn&#39;t create an inner module within <code>MyNamespace</code> but exposes the functions in <code>MyModule</code> directly to make the code compatible with ES2015 bundlers. Let&#39;s see how it works when we&#39;re consuming the code:</p>
<pre><code class="language-fsharp"><span class="token preprocessor property">#load </span><span class="token string">"MyLib.fs"</span>

<span class="token keyword">open</span> MyNamespace<span class="token punctuation">.</span>MyModule

<span class="token keyword">let</span> <span class="token keyword">private</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> bar <span class="token number">5</span>
  printfn <span class="token string">"%i"</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<pre><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> fsFormat <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"fable-core/String"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> bar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MyLib"</span>

<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fsFormat</span><span class="token punctuation">(</span><span class="token string">"%i"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Fable is just importing the function we need, the way ES2015 modules are intended to be. The clear difference with raw JS here is we don&#39;t need to make the imports explicit: if we replace <code>bar</code> with <code>foo</code> Fable will change the import automatically. As you can see, this works not only for our code but also for functions in <code>fable-core</code> (the JS translation of FSharp.Core).</p>
<p>The example was just to show that opening a module doesn&#39;t import everything, but in order to get autocompletion we just need to qualify the module name instead. The generated JS code will be the same.</p>
<p><img src="/img/blog/capture2.png" alt="Autocompletion"></p>
<p>This means we can do exploratory programming while still having all the advantages of tree-shaking: the best of two worlds! (my favourite sentence). And, as you probably know, F# has many tools to write and read documentation directly in code. With <a href="http://ionide.io/">Ionide</a> you even get formatting for markdown comments!</p>
<p><img src="/img/blog/capture1.jpg" alt="Markdown"></p>
<p>Have I convinced you yet to use the Fable + ES2015 bundler combo? Great! Now you just need to do is to find the right bundler, install it, learn how to configure it, make sure to run it after every Fable compilation... No, wait! <a href="http://fable.io/blog/Introducing-0-7.html#ES2015-Modules-and-Bundling">Fable 0.7 comes with Rollup embedded</a> so the only thing you need to bundle your code and dependencies with tree shaking is:</p>
<pre><code>fable src/MyProject.fsproj --rollup</code></pre><p>And that&#39;s it!</p>
<hr>
<p>Hope you liked the post and give Fable a try. Please check the web and the documentation (being updated to 0.7 at the moment) and come to the <a href="https://gitter.im/fable-compiler/Fable">Gitter channel</a> if you have any question. Also make sure to follow the other posts of the awesome <a href="https://sergeytihon.wordpress.com/2016/10/23/f-advent-calendar-in-english-2016/">F# advent calendar</a> and keep tuned with Fable&#39;s website and <a href="https://twitter.com/FableCompiler">Twitter</a> for other exciting announcements!</p>
</div></div><div class="column"></div></div></div></div><footer style="background-color:dodgerblue"><div class="content"><p>Fable <a href="https://github.com/fable-compiler/Fable">source code</a> is licensed <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.</p></div></footer><script>
document.addEventListener('DOMContentLoaded', function () {
  // burger
  var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  if ($navbarBurgers.length > 0) {
    $navbarBurgers.forEach(function ($el) {
      $el.addEventListener('click', function () {
        var target = $el.dataset.target;
        var $target = document.getElementById(target);
        $el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  }
});</script></body></html>