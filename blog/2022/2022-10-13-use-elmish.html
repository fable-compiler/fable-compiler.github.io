<html class="has-navbar-fixed-top" lang="en"><head><title>Fable · Elmish Components with Elmish 4 and UseElmish</title><meta http-equiv="content-type" content="text/html; charset=UTF-8" charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" type="text/css" href="/style.css"/><script src="https://unpkg.com/scroll-into-view-if-needed@2.2.28/umd/scroll-into-view-if-needed.min.js"></script></head><body><nav class="navbar is-fixed-top is-spaced"><div class="container"><div class="navbar-brand"><a class="navbar-item title is-4" href="https://fable.io/">Fable</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/docs">Documentation</a><a class="navbar-item is-hidden-mobile" href="/packages/">Packages</a><a class="navbar-item is-hidden-mobile" href="/repl/">Try</a><a class="navbar-item is-active" href="/blog/index.html">Blog</a><a class="navbar-item is-hidden-mobile" href="/community.html">Community</a><a class="navbar-item is-hidden-mobile" href="/resources.html">Resources</a><div class="navbar-item navbar-burger-dots is-hidden-tablet"><svg height="4" stroke="none" viewBox="0 0 22 4" width="22"><circle cx="2" cy="2" r="2"></circle><circle cx="2" cy="2" r="2" transform="translate(9,0)"></circle><circle cx="2" cy="2" r="2" transform="translate(18,0)"></circle></svg></div></div><div class="navbar-end is-hidden-mobile"><a class="navbar-item" href="https://github.com/fable-compiler/fable"><span class="icon"><i class=" fab fa-github fa-lg"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler"><span class="icon"><i class=" fab fa-twitter fa-lg"></i></span></a><a class="navbar-item" href="https://gitter.im/fable-compiler/Fable"><span class="icon"><i class=" fab fa-gitter fa-lg"></i></span></a><a class="navbar-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos"><span class="icon"><i class=" fab fa-youtube fa-lg"></i></span></a></div></div><div class="nacara-navbar-menu"><a class="nacara-navbar-menu-item" href="/packages/">Packages</a><a class="nacara-navbar-menu-item" href="/repl/">Try</a><a class="nacara-navbar-menu-item" href="/community.html">Community</a><a class="nacara-navbar-menu-item" href="/resources.html">Resources</a><a class="nacara-navbar-menu-item" href="https://github.com/fable-compiler/fable">Github</a><a class="nacara-navbar-menu-item" href="https://twitter.com/FableCompiler">Twitter</a><a class="nacara-navbar-menu-item" href="https://gitter.im/fable-compiler/Fable">Gitter</a><a class="nacara-navbar-menu-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos">Youtube</a></div></div></nav><div class="grey-overlay"></div><div class="nacara-content"><div class="container"><div class="columns"><div class="column is-8-desktop is-offset-2-desktop"><div class="section blog-post"><figure class="image is-96x96 author-image"><img class="is-rounded" src="https://github.com/alfonsogarciacaro.png"/></figure><h2 class="title is-size-3 has-text-primary has-text-weight-normal has-text-centered blog-title">Elmish Components with Elmish 4 and UseElmish</h2><div class="tags has-addons is-justify-content-center"><a class="tag is-rounded is-medium is-primary" href="https://twitter.com/alfonsogcnunez">Alfonso García-Caro</a><span class="tag is-rounded is-medium">October 13, 2022</span></div><div class="content"><style class=grvsc-styles>.grvsc-container{overflow:auto;position:relative;-webkit-overflow-scrolling:touch;padding-top:1rem;padding-top:var(--grvsc-padding-top,var(--grvsc-padding-v,1rem));padding-bottom:1rem;padding-bottom:var(--grvsc-padding-bottom,var(--grvsc-padding-v,1rem));border-radius:8px;border-radius:var(--grvsc-border-radius,8px);font-feature-settings:normal;line-height:1.4}.grvsc-code{display:table}.grvsc-line{display:table-row;box-sizing:border-box;width:100%;position:relative}.grvsc-line>*{position:relative}.grvsc-gutter-pad{display:table-cell;padding-left:.75rem;padding-left:calc(var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem))/ 2)}.grvsc-gutter{display:table-cell;-webkit-user-select:none;-moz-user-select:none;user-select:none}.grvsc-gutter::before{content:attr(data-content)}.grvsc-source{display:table-cell;padding-left:1.5rem;padding-left:var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem));padding-right:1.5rem;padding-right:var(--grvsc-padding-right,var(--grvsc-padding-h,1.5rem))}.grvsc-source:empty::after{content:' ';-webkit-user-select:none;-moz-user-select:none;user-select:none}.grvsc-gutter+.grvsc-source{padding-left:.75rem;padding-left:calc(var(--grvsc-padding-left,var(--grvsc-padding-h,1.5rem))/ 2)}.grvsc-has-line-highlighting>.grvsc-code>.grvsc-line::before{content:' ';position:absolute;width:100%}.grvsc-line-diff-add::before{background-color:var(--grvsc-line-diff-add-background-color,rgba(0,255,60,.2))}.grvsc-line-diff-del::before{background-color:var(--grvsc-line-diff-del-background-color,rgba(255,0,20,.2))}.grvsc-line-number{padding:0 2px;text-align:right;opacity:.7}.atom-one-light{background-color:#fafafa;color:#383a42}.atom-one-light .mtki{font-style:italic}.atom-one-light .mtk14{color:#a626a4}.atom-one-light .mtk1{color:#383a42}.atom-one-light .mtk9{color:#4078f2}.atom-one-light .mtk7{color:#a0a1a7}.atom-one-light .mtk5{color:#e45649}.atom-one-light .mtk6{color:#986801}.atom-one-light .mtk10{color:#50a14f}.atom-one-light .mtk8{color:#0184bc}.atom-one-light .grvsc-line-highlighted::before{background-color:var(--grvsc-line-highlighted-background-color,rgba(0,0,0,.05));box-shadow:inset var(--grvsc-line-highlighted-border-width,4px) 0 0 0 var(--grvsc-line-highlighted-border-color,rgba(0,0,0,.2))}</style><p><a href=https://elmish.github.io/elmish/>Elmish</a>, the F# implementation of the Elm Architecture, has proven to be a simple yet powerful way of managing state in UI apps. However, it's been often criticized because it was designed for monolithic applications that couldn't take advantage of the component architecture of modern UI frameworks like React. Although it made your app more robust, users didn't like the boilerplate necessary to glue the full component hierarchy into a single global Elmish program. The criticism was fair, why does your model need to know about UI details like a modal? Is it really necessary to wrap the message of all children components even when they didn't have anything to "tell" their parents?<p><a href=https://zaid-ajaj.github.io/Feliz/#/Hooks/UseElmish>Feliz.UseElmish</a> appeared as a custom React hook to solve this situation, allowing you to use Elmish at the component-level. This was a great advancement but its full potential was still blocked by two problems:<ol><li>React hooks were not designed with external stores in mind.<li>Elmish didn't check for termination of Elmish programs and didn't clean up subscriptions.</ol><p>Because of the first issue, the internal code of <code>UseElmish</code> was quite complicated and didn't play well with React features like <a href=https://github.com/facebook/react/issues/16604#issuecomment-528663101>Fast Refresh</a>. And the second problem meant users had to implement their own custom code to dispose subscriptions (and be careful they didn't forget to do it). All in all, the development experience was still not ideal.<p>Thankfully, these problems have been solved now thanks to React 18 (with the new <a href=https://beta.reactjs.org/learn/you-might-not-need-an-effect#subscribing-to-an-external-store>useSyncExternalStore</a> hook) and Elmish 4 (published as beta at the time of writing). The new Elmish version includes termination capabilities and subscription cleanup, so instead of assuming there is one single global Elmish program, now you have full control of its lifecycle, which makes integration with React components a breeze.<h2>Elmish 4 Subscriptions</h2><p>Subscriptions are becoming much more powerful with Elmish 4:<ul><li>Subscriptions must include now an <code>IDisposable</code> that will be invoked by Elmish when cleaning up.<li>The <code>Program.withSubscription</code> function is now evaluated after every update. This makes it really easy to activate or deactivate subscriptions on demand.</ul><p>Let's say your app can start a web socket connection with the server to check your friends' status, but this is a feature users can turn on and off with a switch. Before, you had to manage all of this in your <code>update</code> function, likely having to keep a reference to the connection ID in your model. Now you can delegate this responsibility to subscription in a much more convenient way:<pre class="atom-one-light grvsc-container"data-index=0 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>open</span><span class=mtk1> </span><span class=mtk9>Elmish</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class="mtk7 mtki">/// Feliz has already a similar helper: React.createDisposable</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk14>private</span><span class=mtk1> </span><span class=mtk5>mkDisposable</span><span class=mtk1> f </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>{</span><span class=mtk1> </span><span class=mtk14>new</span><span class=mtk1> System.IDisposable </span><span class=mtk14>with</span><span class=mtk1> </span><span class=mtk14>member</span><span class=mtk1> </span><span class=mtk5>_.Dispose</span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>=</span><span class=mtk1> f</span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>}</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk14>private</span><span class=mtk1> </span><span class=mtk5>mkProgram</span><span class=mtk1> </span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    Program.mkProgram init update view</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>|></span><span class=mtk1> Program.withSubscription </span><span class=mtk14>(fun</span><span class=mtk1> model </span><span class=mtk14>-></span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>        </span><span class=mtk14>[</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>            </span><span class=mtk14>if</span><span class=mtk1> model.CheckFriendsStatus </span><span class=mtk14>then</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>                </span><span class=mtk14>[</span><span class=mtk10>"friends-status"</span><span class=mtk14>],</span><span class=mtk1> </span><span class=mtk14>(fun</span><span class=mtk1> dispatch </span><span class=mtk14>-></span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>                    </span><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>id</span><span class=mtk1> </span><span class=mtk14>=</span><span class=mtk1> startWebSocket</span><span class=mtk14>(</span><span class=mtk1>dispatch</span><span class=mtk14>)</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>                    mkDisposable </span><span class=mtk14>(fun</span><span class=mtk1> </span><span class=mtk14>()</span><span class=mtk1> </span><span class=mtk14>-></span><span class=mtk1> closeWebSocket</span><span class=mtk14>(</span><span class=mtk1>id</span><span class=mtk14>)))</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>        </span><span class=mtk14>])</span></span></span></code></pre><p>Thanks to the ID, after each update Elmish can check what subscriptions are new, remain active, or must be cleaned up. Your code doesn't need to care about all of this anymore!<blockquote><p>Note the subscription ID is <code>string list</code> instead of just <code>string</code>. This is because of the composable nature of Elmish. If your program were to be wrapped, the extension can just prefix your subscriptions, so it's easier to identify the "route" through which subscriptions are activated.</blockquote><h2>Fable.React.UseElmish</h2><p>Fable.React.UseElmish is the spiritual successor of Feliz.UseElmish and takes advantage of React 18 and Elmish 4 to bring you the best of both worlds. You can use it in any React app (either using Fable.React, Feliz or Fable.Core.JSX). It shares the same API as Feliz.UseElmish, so the only thing you need to do for upgrading is to replace the package and remove the <code>open Feliz.UseElmish</code> statement (if necessary, replace it with <code>open Fable.React</code>).<p>As before, you can pass the hook a function to initialize your Elmish program or direct references to <code>init</code> and <code>update</code>. You can also pass an argument to initialize the program and/or a dependency array. When either the argument or any of the dependencies change, UseElmish will reset the program.<pre class="atom-one-light grvsc-container"data-index=1 data-language=fsharp><code class=grvsc-code><span class=grvsc-line><span class=grvsc-source><span class=mtk14>open</span><span class=mtk1> </span><span class=mtk9>Fable.React</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>open</span><span class=mtk1> </span><span class=mtk9>Feliz</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>open</span><span class=mtk1> </span><span class=mtk9>Elmish</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk14>private</span><span class=mtk1> </span><span class=mtk5>mkProgram</span><span class=mtk1> </span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class="mtk7 mtki">// We pass a dummy function as `view` because we don't need it</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    Program.mkProgram init update </span><span class=mtk14>(fun</span><span class=mtk1> _ _ </span><span class=mtk14>-></span><span class=mtk1> </span><span class=mtk14>())</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class="mtk7 mtki">// Add subscriptions</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>|></span><span class=mtk1> Program.withSubscription </span><span class=mtk14>..</span><span class=mtk1>.</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class="mtk7 mtki">// Add custom Elmish extensions</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>|></span><span class=mtk1> Program.withXXX</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk8>[&#60ReactComponent>]</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>App</span><span class=mtk1> </span><span class=mtk6>()</span><span class=mtk1> </span><span class=mtk14>=</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class=mtk14>let</span><span class=mtk1> </span><span class=mtk5>model</span><span class=mtk14>,</span><span class=mtk1> dispatch </span><span class=mtk14>=</span><span class=mtk1> React.useElmish </span><span class=mtk14>(</span><span class=mtk1>mkProgram</span><span class=mtk14>,</span><span class=mtk1> arg </span><span class=mtk14>=</span><span class=mtk1> </span><span class=mtk6>2</span><span class=mtk14>)</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class="mtk7 mtki">// If you don't have subscriptions or custom extensions you can pass the init an update functions directly</span></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class="mtk7 mtki">// let model, dispatch = React.useElmish (init, update, arg = 2)</span></span></span>
<span class=grvsc-line><span class=grvsc-source></span></span>
<span class=grvsc-line><span class=grvsc-source><span class=mtk1>    </span><span class="mtk7 mtki">// View code</span></span></span></code></pre><p>You can check <a href=https://github.com/alfonsogarciacaro/fable-react-sample/blob/3fc0f5ca2411432d3a34e12344fcca2a4ba6a4ce/src/TodoMVC.fs#L198>this example</a> to quickly test Fable.React.UseElmish. Just clone the repository and run <code>npm install &#38&#38 npm start</code> to launch a development server, and try editing the code in TodoMVC.fs to see the web contents updated on the fly. Please give it a try and let us know what you think!<blockquote><p>In order for React Fast Refresh to work, files must <strong>export only React components</strong>, that is, functions decorated with <code>Feliz.ReactComponent</code> or <code>JSX.Component</code> and using PascalCase. The rest of the code in the file must be private.</blockquote><p>Special thanks to Eugene Tolmachev, Maxime Mangel, Zaid Ajaj, Cody Johnson and all the other contributors that have turned writing React apps in F# into such a great development experience!</div></div></div></div></div></div><script async="" src="/resources/nacara-standard-layouts/scripts/menu.js"></script></body></html>